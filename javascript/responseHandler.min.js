
//	Response Handlers as AJAX Calls

function loginAdapter(){
	$('#login').click(function(){
		var user = $('#senderUsername').val();
		var pass = $('#senderPassword').val();
		$.ajax({
			type: "POST",
			url: "./func/requestsHandler.php",
			data: { operation: "authenticate", username: user, password: pass },
			statusCode: {
				401: function() {
					$("#failureMessage").fadeIn(500, function(){
						setTimeout(function(){
							$("#failureMessage").fadeOut();
						}, 2000);
					});
				},
				200: function() {
					window.location.href = "/";
				},
			}
		});
		
	});
}

function contactAdapter(){
	$('#sendMessage').click(function(){
		var senderName = $('#senderName').val();
		var senderEmail = $('#senderEmail').val();
		var message = $('#message').val();
		$.ajax({
			type: "POST",
			url: "./func/requestsHandler.php",
			data: { operation: 'contact', sender: senderName, email: senderEmail, message: message},
		}).done(function(){
			$('#sendMessage').fadeOut();
		});
	});
}

function arrayObjToString(obj){
	return obj.toString();
}

function arrayObjToInteger(obj){
	return Number(obj.toString());
}

function registerAdapter(){
	var reqParams = {
		operation : "createUser"
	}
	
	$('#registerButton').click(function(){
		var invalid = false;
		var passConfirm;
		$('#regform div input[name]').each(function(){
			
			var val = $(this).val();
			if (this.name == "password_confirm"){
				passConfirm = val;
				return; // go to the next one, no need to save this
			}
			
			if (val == ""){
				invalid = true;
			}
			reqParams[this.name] = val;
			
		});
		
		reqParams["bio"] = $("#bioText").val();
		reqParams["gender"] = $("#genderregister").val();
		reqParams["experience"] = $("#exregister").val();
		
		console.log(reqParams);
				
		if (invalid || reqParams["password"] != passConfirm){
			alert("Please complete all the fields and make sure your password and the confirmation are the same"); // TODO Select a subset of the fields that are required
			return;
		}
		
		$.ajax({
			type: "POST",
			url: "http://fitness.desigyn.com/func/requestsHandler.php",
			data: reqParams,
			
			success : function(data){
				alert('Your profile has been created!');
				console.log(data);
				window.location.href = './index.php';
			},
			
			error : function(xhr, status){
				alert('Error occured. Please try again later. ('+status+')');
			}
		})
	
	});
}

function searchAdapter(){
	if($('#searchInput').val() != ''){
			$.ajax({
				type: "POST",
				url: "./func/requestsHandler.php",
				data: { operation: 'search', key: $('#searchInput').val()},
			}).done(function(msg){

				var mmsg = $.parseJSON(msg);
				$('.searchresults ul').append('<p>Displaying ' + mmsg.length + ' results </p><hr>');
				for(var i = 0; i<mmsg.length ; i++){
					$('.searchresults ul').append('<li><a href="/profile.php?id=' + mmsg[i].id + '">(' + mmsg[i].name + ') ' + mmsg[i].username +'</a></li><hr>');
				};
				
			});
	}

	$('#searchSubmit').live("click",function(){
		$('.searchresults ul').empty();
		var searched = $(this).parent().find('input').val();

		if(searched != ' '){	
			$.ajax({
				type: "POST",
				url: "./func/requestsHandler.php",
				data: { operation: 'search', key: searched},
			}).done(function(msg){

				var mmsg = $.parseJSON(msg);
				$('.searchresults ul').append('<p>Displaying ' + mmsg.length + ' results </p><hr>');
				for(var i = 0; i<mmsg.length ; i++){
					$('.searchresults ul').append('<li><a href="/profile.php?id=' + mmsg[i].id + '">(' + mmsg[i].name + ') ' + mmsg[i].username +'</a></li><hr>');
				};
				
			});
		}
		else{
			alert('Search Bar cannot be empty');
		}
	});
}

function editProfileAdapter(){
	// Set the operation
	var reqParams = {
		operation : "editProfile"
	};
	
	$('#saveeditprofile').live('click',function(){
		// Init request parameters
		
		var biotext = $('.editprofilepage textarea').val();
		reqParams["bio"] = biotext;
		
		$('#editprofiledetails input').each(function(){
			reqParams[this.name] = $(this).val();
		});

		$.ajax({
			type: "POST",
			url: "../func/requestsHandler.php",
			data: reqParams,
			success : function(response, status){
				window.location.href = '/profile.php';
			}, 
			
			error : function(xhr, status){
				alert("ERROR: "+status);
			}
		});
	});
}
function commentAdapter(){
	$('#submitComment').live("click",function(){

		var message = $(this).parent().find('textarea').val();
		var fitness_id = $('#fitness_id').val();
		$.ajax({
			type: "POST",
			url: "./func/requestsHandler.php",
			data: { operation: 'addComment', comment: message, fitness_id: fitness_id},
			statusCode: {
				403: function() {
					alert('fail');
				},
			}
		}).done(function(){
			location.reload();
		});
	});
}


//	Response Adapters' Initializer
function adapterInit(){
	contactAdapter();
	loginAdapter();
	registerAdapter();
	searchAdapter();
	editProfileAdapter();
	commentAdapter();
}